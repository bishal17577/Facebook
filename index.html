<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Smart City ‚Äî Map (Gajuri / Malekhu / Galchi)</title>
    <style>
        :root {
            --panel-bg: #ffffffee;
            --accent: #2b8aee;
            --danger: #e84141;
            --success: #4CAF50;
            --bottom-nav-height: 70px;
            --header-height: 60px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            background: #f4f6fb;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: linear-gradient(90deg, #fff, #f1f8ff);
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 100;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #ddd;
            object-fit: cover;
            margin-right: 10px;
        }
        
        .header h1 {
            font-size: 18px;
            color: #0b3a66;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .search-container {
            position: relative;
            flex: 1;
            max-width: 300px;
        }
        
        #search {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid #ccc;
            background: white;
            font-size: 14px;
        }
        
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.08);
            max-height: 200px;
            overflow-y: auto;
            z-index: 101;
            display: none;
        }
        
        .suggestions .item {
            display: flex;
            gap: 10px;
            padding: 10px;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .suggestions .item:last-child {
            border-bottom: 0;
        }
        
        .suggestions .item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .empty {
            color: #777;
            font-size: 13px;
            padding: 15px;
            text-align: center;
        }
        
        /* Main Map Area */
        .map-container {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            bottom: var(--bottom-nav-height);
            background: #e9f0ff;
            overflow: hidden;
        }
        
        .map-wrap {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 0;
            overflow: hidden;
            background: #fff;
        }
        
        #map {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
            transform-origin: 0 0;
        }
        
        .marker {
            position: absolute;
            transform: translate(-50%, -100%);
            cursor: pointer;
            user-select: none;
        }
        
        .marker .dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 8px rgba(43,138,238,0.65);
            border: 2px solid #fff;
        }
        
        .marker .label {
            display: block;
            background: #fff;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 4px;
            font-size: 12px;
            border: 1px solid #ddd;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .marker.blink .dot {
            animation: blink 0.8s infinite;
        }
        
        @keyframes blink {
            0% { box-shadow: 0 0 6px rgba(232,65,65,0.3); }
            50% { box-shadow: 0 0 18px rgba(232,65,65,0.9); }
            100% { box-shadow: 0 0 6px rgba(232,65,65,0.3); }
        }
        
        .center-hint {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 15px;
            background: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #eee;
            opacity: 0.9;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            z-index: 100;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            flex: 1;
            max-width: 80px;
        }
        
        .nav-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-btn.active {
            color: var(--accent);
            background: rgba(43, 138, 238, 0.1);
        }
        
        .nav-btn.emergency {
            color: var(--danger);
        }
        
        /* Panels (Overlays) */
        .panel {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            bottom: var(--bottom-nav-height);
            background: white;
            z-index: 90;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }
        
        .panel.active {
            transform: translateY(0);
            display: block;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .panel-title {
            font-size: 18px;
            color: #0b3a66;
        }
        
        .close-panel {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
        }
        
        /* Places List */
        .place-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .place-row {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #eee;
            background: #f9f9f9;
        }
        
        .place-row img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .place-meta {
            flex: 1;
        }
        
        .place-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .place-cat {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .place-desc {
            font-size: 14px;
            color: #444;
        }
        
        .place-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .btn.danger {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        
        .btn.success {
            background: var(--success);
            color: #fff;
            border-color: var(--success);
        }
        
        .btn.small {
            font-size: 12px;
            padding: 6px 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* Category Filter */
        .cat-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .cat-filter button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: #fff;
            font-size: 13px;
            cursor: pointer;
        }
        
        .cat-filter button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Thumbnails */
        .thumbs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .thumbs img, .thumbs video {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        
        /* Emergency Panel */
        .emergency-panel {
            background: #ffecec;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #f5c6c6;
            margin-bottom: 15px;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .modal.open {
            display: flex;
        }
        
        .modal .card {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            max-width: 95%;
            width: 500px;
            max-height: 90vh;
            overflow: auto;
        }
        
        /* Gallery */
        .gallery {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .gallery img, .gallery video {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .thumbnails {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 0;
        }
        
        .thumbnails img, .thumbnails video {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: white;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Category Badge */
        .category-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: #fff;
            display: inline-block;
            margin-right: 8px;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-10 {
            margin-top: 10px;
        }
        
        .mb-10 {
            margin-bottom: 10px;
        }
        
        .p-10 {
            padding: 10px;
        }
    </style>
</head>
<body>
    <!-- Header with Search -->
    <div class="header">
        <img src="" alt="logo" class="logo" id="logo">
        <h1>Mini Smart City Map</h1>
        <div class="search-container">
            <input id="search" type="text" placeholder="Search places...">
            <div id="suggestions" class="suggestions"></div>
        </div>
    </div>
    
    <!-- Main Map Area -->
    <div class="map-container">
        <div class="map-wrap">
            <div class="center-hint">Tap map to add marker</div>
            <img id="map" src="project.png" alt="map image">
            <!-- Markers will be injected here -->
            
            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button id="zoomIn" class="zoom-btn">+</button>
                <button id="zoomOut" class="zoom-btn">-</button>
                <button id="resetZoom" class="zoom-btn">‚Ü∫</button>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" data-panel="home">
            <i>üó∫Ô∏è</i>
            <span>Map</span>
        </button>
        <button class="nav-btn" data-panel="places">
            <i>üìç</i>
            <span>Places</span>
        </button>
        <button class="nav-btn" data-panel="add">
            <i>‚ûï</i>
            <span>Add</span>
        </button>
        <button class="nav-btn" data-panel="emergency">
            <i>üö®</i>
            <span>Emergency</span>
        </button>
        <button class="nav-btn" data-panel="settings">
            <i>‚öôÔ∏è</i>
            <span>Settings</span>
        </button>
    </div>
    
    <!-- Panels (Overlays) -->
    
    <!-- Places Panel -->
    <div id="placesPanel" class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Places</h2>
            <button class="close-panel">‚úï</button>
        </div>
        
        <div class="cat-filter">
            <button data-cat="" class="active">All</button>
            <button data-cat="parking">Parking</button>
            <button data-cat="hotel">Hotel</button>
            <button data-cat="museum">Museum</button>
            <button data-cat="jungle">Jungle/Park</button>
            <button data-cat="waterfall">Waterfall</button>
            <button data-cat="school">School</button>
            <button data-cat="hospital">Hospital</button>
            <button data-cat="court">Court</button>
            <button data-cat="office">Office</button>
        </div>
        
        <div class="place-list" id="placeList"></div>
    </div>
    
    <!-- Add Place Panel -->
    <div id="addPanel" class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Add New Place</h2>
            <button class="close-panel">‚úï</button>
        </div>
        
        <form id="addForm">
            <div class="form-group">
                <label for="pname">Name</label>
                <input id="pname" type="text" class="form-control" placeholder="Place name (e.g. Gajuri Park)" required>
            </div>
            
            <div class="form-group">
                <label for="pcat">Category</label>
                <select id="pcat" class="form-control">
                    <option value="">-- choose category --</option>
                    <option value="parking">Parking</option>
                    <option value="hotel">Hotel</option>
                    <option value="museum">Museum</option>
                    <option value="jungle">Jungle/Park</option>
                    <option value="waterfall">Waterfall</option>
                    <option value="school">School</option>
                    <option value="hospital">Hospital</option>
                    <option value="court">Supreme Court</option>
                    <option value="office">Office</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="px">X Coordinate (%)</label>
                    <input id="px" type="text" class="form-control" placeholder="x %">
                </div>
                <div class="form-group">
                    <label for="py">Y Coordinate (%)</label>
                    <input id="py" type="text" class="form-control" placeholder="y %">
                </div>
            </div>
            
            <div class="form-group">
                <label for="pdesc">Description</label>
                <textarea id="pdesc" class="form-control" rows="3" placeholder="Short description"></textarea>
            </div>
            
            <div class="form-group">
                <label for="pfiles">Upload photos/videos (max 6)</label>
                <input id="pfiles" type="file" class="form-control" multiple accept="image/*,video/*">
                <div class="thumbs" id="thumbs"></div>
            </div>
            
            <div class="form-group">
                <button id="savePlace" class="btn primary" type="button" style="width: 100%; padding: 12px;">Save Place</button>
            </div>
            
            <div class="form-row">
                <button id="clearForm" class="btn" type="button" style="flex: 1;">Clear</button>
                <button id="cancelAdd" class="btn" type="button" style="flex: 1;">Cancel</button>
            </div>
        </form>
    </div>
    
    <!-- Emergency Panel -->
    <div id="emergencyPanel" class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Emergency</h2>
            <button class="close-panel">‚úï</button>
        </div>
        
        <div class="emergency-panel">
            <div class="form-group">
                <label for="emPlace">Select Location</label>
                <select id="emPlace" class="form-control"></select>
            </div>
            
            <button id="triggerEmergency" class="btn danger" style="width: 100%; padding: 12px; margin-bottom: 10px;">EMERGENCY</button>
            
            <div id="emInfo"></div>
        </div>
        
        <div class="p-10 text-center">
            <p>In case of emergency, this will highlight the selected location on the map for 12 seconds.</p>
        </div>
    </div>
    
    <!-- Settings Panel -->
    <div id="settingsPanel" class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Settings</h2>
            <button class="close-panel">‚úï</button>
        </div>
        
        <div class="form-group">
            <button id="exportAll" class="btn primary" style="width: 100%; padding: 12px; margin-bottom: 10px;">Export Data (JSON)</button>
            <p class="text-center">Export all places data to a JSON file</p>
        </div>
        
        <div class="form-group">
            <button id="importData" class="btn success" style="width: 100%; padding: 12px; margin-bottom: 10px;">Import Data</button>
            <p class="text-center">Import places data from a JSON file</p>
        </div>
        
        <div class="form-group">
            <button id="clearAllData" class="btn danger" style="width: 100%; padding: 12px; margin-bottom: 10px;">Clear All Data</button>
            <p class="text-center">Delete all places data (cannot be undone)</p>
        </div>
        
        <div class="p-10 text-center">
            <p>All data is saved locally in your browser (localStorage)</p>
        </div>
    </div>
    
    <!-- Modal for Place Details -->
    <div id="modal" class="modal" aria-hidden="true">
        <div class="card" role="dialog" aria-modal="true">
            <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom: 15px;">
                <strong id="modalTitle">Place</strong>
                <button id="modalClose" class="btn">Close</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Configuration
        const MAP_IMG_SRC = "map for smart city.png";
        const STORAGE_KEY = "miniCityPlaces_v1";
        
        // State
        let places = [];
        let currentPanel = 'home';
        let zoom = 1;
        
        // DOM Elements
        const mapEl = document.getElementById('map');
        const markerContainer = document.querySelector('.map-wrap');
        const searchInput = document.getElementById('search');
        const suggestionsEl = document.getElementById('suggestions');
        const placeListEl = document.getElementById('placeList');
        const navButtons = document.querySelectorAll('.nav-btn');
        const panels = document.querySelectorAll('.panel');
        const closeButtons = document.querySelectorAll('.close-panel');
        
        // Initialize the app
        function init() {
            // Set map image
            mapEl.src = MAP_IMG_SRC;
            document.getElementById('logo').src = MAP_IMG_SRC;
            
            // Load data
            loadPlaces();
            renderMarkers();
            populateEmList();
            
            // Set up event listeners
            setupEventListeners();
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Navigation
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const panel = btn.dataset.panel;
                    showPanel(panel);
                    
                    // Update active state
                    navButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            // Close panels
            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    showPanel('home');
                    navButtons.forEach(b => {
                        if (b.dataset.panel === 'home') b.classList.add('active');
                        else b.classList.remove('active');
                    });
                });
            });
            
            // Search functionality
            searchInput.addEventListener('input', handleSearch);
            document.addEventListener('click', () => {
                suggestionsEl.style.display = 'none';
            });
            
            // Map click to add coordinates
            markerContainer.addEventListener('click', handleMapClick);
            
            // Zoom controls
            document.getElementById('zoomIn').addEventListener('click', () => {
                zoom = Math.min(3, zoom + 0.1);
                mapEl.style.transform = `scale(${zoom})`;
            });
            
            document.getElementById('zoomOut').addEventListener('click', () => {
                zoom = Math.max(0.5, zoom - 0.1);
                mapEl.style.transform = `scale(${zoom})`;
            });
            
            document.getElementById('resetZoom').addEventListener('click', () => {
                zoom = 1;
                mapEl.style.transform = `scale(${zoom})`;
            });
            
            // Category filters
            document.querySelectorAll('.cat-filter button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.cat-filter button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const cat = btn.dataset.cat || '';
                    renderPlaceList(cat);
                });
            });
            
            // Add place form
            document.getElementById('savePlace').addEventListener('click', savePlace);
            document.getElementById('clearForm').addEventListener('click', clearForm);
            document.getElementById('cancelAdd').addEventListener('click', () => showPanel('home'));
            
            // File upload
            document.getElementById('pfiles').addEventListener('change', handleFileUpload);
            
            // Emergency
            document.getElementById('triggerEmergency').addEventListener('click', triggerEmergency);
            
            // Settings
            document.getElementById('exportAll').addEventListener('click', exportAllData);
            document.getElementById('clearAllData').addEventListener('click', clearAllData);
            
            // Modal
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modal')) closeModal();
            });
        }
        
        // Show/hide panels
        function showPanel(panelName) {
            currentPanel = panelName;
            
            // Hide all panels
            panels.forEach(panel => {
                panel.classList.remove('active');
            });
            
            // If home, just show map
            if (panelName === 'home') {
                return;
            }
            
            // Show selected panel
            const panel = document.getElementById(panelName + 'Panel');
            if (panel) {
                panel.classList.add('active');
                
                // If showing places panel, render the list
                if (panelName === 'places') {
                    renderPlaceList();
                }
            }
        }
        
        // The rest of the JavaScript functions from the original code would go here
        // (loadPlaces, savePlaces, renderMarkers, renderPlaceList, handleSearch, etc.)
        // For brevity, I'm including just the essential ones
        
        function loadPlaces() {
            try {
                places = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || [];
            } catch(e) {
                places = [];
            }
            
            // Add demo data if empty
            if (places.length === 0) {
                places = [
                    { id: 'p1', name: 'Gajuri Market', cat: 'office', desc: 'Central market area', xPct: 10, yPct: 10, media: [], created: Date.now() - 86400000 },
                    { id: 'p2', name: 'Malekhu Parking', cat: 'parking', desc: 'Main parking near road', xPct: 50, yPct: 88, media: [], created: Date.now() - 3600000 },
                    { id: 'p3', name: 'Galchi Jungle', cat: 'jungle', desc: 'Small forest/park area with waterfall', xPct: 85, yPct: 18, media: [], created: Date.now() - 7200000 }
                ];
                savePlaces();
            }
        }
        
        function savePlaces() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(places));
            renderPlaceList();
            renderMarkers();
            populateEmList();
        }
        
        function renderMarkers() {
            // Clear existing markers
            document.querySelectorAll('.marker').forEach(m => m.remove());
            
            // Add markers for each place
            places.forEach(place => {
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.left = place.xPct + '%';
                marker.style.top = place.yPct + '%';
                marker.dataset.id = place.id;
                
                marker.innerHTML = `
                    <div class="dot" title="${place.name}"></div>
                    <div class="label">${place.name}</div>
                `;
                
                marker.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openPlaceModal(place.id);
                });
                
                markerContainer.appendChild(marker);
            });
        }
        
        function renderPlaceList(filterCat = '') {
            if (!placeListEl) return;
            
            placeListEl.innerHTML = '';
            
            const filteredPlaces = filterCat ? 
                places.filter(p => p.cat === filterCat) : 
                places;
                
            if (filteredPlaces.length === 0) {
                placeListEl.innerHTML = '<div class="empty">No places found</div>';
                return;
            }
            
            filteredPlaces.forEach(place => {
                const placeEl = document.createElement('div');
                placeEl.className = 'place-row';
                
                const thumbSrc = place.media && place.media.length ? 
                    place.media[0].data : MAP_IMG_SRC;
                
                placeEl.innerHTML = `
                    <img src="${thumbSrc}" alt="${place.name}">
                    <div class="place-meta">
                        <div class="place-name">${place.name}</div>
                        <div class="place-cat">${place.cat || '‚Äî'} ‚Ä¢ ${new Date(place.created).toLocaleDateString()}</div>
                        <div class="place-desc">${place.desc || ''}</div>
                        <div class="place-actions">
                            <button class="btn small view-btn" data-id="${place.id}">View</button>
                            <button class="btn small center-btn" data-id="${place.id}">Center</button>
                            <button class="btn small delete-btn" data-id="${place.id}">Delete</button>
                        </div>
                    </div>
                `;
                
                placeListEl.appendChild(placeEl);
            });
            
            // Add event listeners to the buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openPlaceModal(btn.dataset.id);
                });
            });
            
            document.querySelectorAll('.center-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    centerOnPlace(btn.dataset.id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this place?')) {
                        places = places.filter(p => p.id !== btn.dataset.id);
                        savePlaces();
                    }
                });
            });
        }
        
        function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (!query) {
                suggestionsEl.style.display = 'none';
                return;
            }
            
            const matches = places.filter(p => 
                p.name.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (matches.length === 0) {
                suggestionsEl.innerHTML = '<div class="empty">No results found</div>';
                suggestionsEl.style.display = 'block';
                return;
            }
            
            suggestionsEl.innerHTML = '';
            matches.forEach(place => {
                const item = document.createElement('div');
                item.className = 'item';
                
                const thumbSrc = place.media && place.media.length ? 
                    place.media[0].data : MAP_IMG_SRC;
                
                item.innerHTML = `
                    <img src="${thumbSrc}" alt="${place.name}">
                    <div>
                        <div>${place.name}</div>
                        <div style="font-size: 12px; color: #666;">${place.cat || ''}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    searchInput.value = place.name;
                    suggestionsEl.style.display = 'none';
                    centerOnPlace(place.id);
                    showPanel('home');
                });
                
                suggestionsEl.appendChild(item);
            });
            
            suggestionsEl.style.display = 'block';
        }
        
        function handleMapClick(e) {
            const rect = mapEl.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const xPct = (x / rect.width) * 100;
            const yPct = (y / rect.height) * 100;
            
            document.getElementById('px').value = xPct.toFixed(2);
            document.getElementById('py').value = yPct.toFixed(2);
            
            // Show add panel with coordinates filled
            showPanel('add');
        }
        
        function handleFileUpload(e) {
            const files = Array.from(e.target.files).slice(0, 6);
            const thumbsContainer = document.getElementById('thumbs');
            thumbsContainer.innerHTML = '';
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const thumb = document.createElement(file.type.startsWith('video') ? 'video' : 'img');
                    if (file.type.startsWith('video')) thumb.controls = true;
                    thumb.src = event.target.result;
                    thumbsContainer.appendChild(thumb);
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function savePlace() {
            const name = document.getElementById('pname').value.trim();
            const cat = document.getElementById('pcat').value;
            const x = parseFloat(document.getElementById('px').value);
            const y = parseFloat(document.getElementById('py').value);
            const desc = document.getElementById('pdesc').value.trim();
            
            if (!name) {
                alert('Please enter a place name');
                return;
            }
            
            if (isNaN(x) || isNaN(y)) {
                alert('Please enter valid coordinates or tap on the map to set them');
                return;
            }
            
            const files = Array.from(document.getElementById('pfiles').files);
            const media = [];
            
            for (const file of files) {
                const dataUrl = await fileToDataUrl(file);
                media.push({
                    type: file.type.startsWith('video') ? 'video' : 'image',
                    data: dataUrl,
                    filename: file.name
                });
            }
            
            const newPlace = {
                id: 'p' + Math.random().toString(36).substr(2, 9),
                name,
                cat,
                xPct: x,
                yPct: y,
                desc,
                media,
                created: Date.now()
            };
            
            places.push(newPlace);
            savePlaces();
            clearForm();
            showPanel('home');
            
            alert('Place added successfully!');
        }
        
        function clearForm() {
            document.getElementById('addForm').reset();
            document.getElementById('thumbs').innerHTML = '';
        }
        
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function populateEmList() {
            const emSelect = document.getElementById('emPlace');
            emSelect.innerHTML = '';
            
            places.forEach(place => {
                const option = document.createElement('option');
                option.value = place.id;
                option.textContent = place.name;
                emSelect.appendChild(option);
            });
        }
        
        function triggerEmergency() {
            const placeId = document.getElementById('emPlace').value;
            const place = places.find(p => p.id === placeId);
            
            if (!place) {
                alert('Please select a location first');
                return;
            }
            
            // Blink the marker
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('blink'));
            const marker = document.querySelector(`.marker[data-id="${placeId}"]`);
            if (marker) marker.classList.add('blink');
            
            // Show info
            document.getElementById('emInfo').innerHTML = `
                <strong>EMERGENCY at ${place.name}</strong>
                <div>${place.desc || ''}</div>
                <div style="margin-top: 8px;">Coordinates: ${place.xPct}%, ${place.yPct}%</div>
            `;
            
            // Stop blinking after 12 seconds
            setTimeout(() => {
                if (marker) marker.classList.remove('blink');
            }, 12000);
            
            // Show map panel
            showPanel('home');
        }
        
        function centerOnPlace(placeId) {
            const place = places.find(p => p.id === placeId);
            if (!place) return;
            
            // In a real app, you would center the map on this location
            // For this demo, we'll just blink the marker
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('blink'));
            const marker = document.querySelector(`.marker[data-id="${placeId}"]`);
            if (marker) {
                marker.classList.add('blink');
                setTimeout(() => marker.classList.remove('blink'), 3000);
            }
            
            showPanel('home');
        }
        
        function openPlaceModal(placeId) {
            const place = places.find(p => p.id === placeId);
            if (!place) return;
            
            document.getElementById('modalTitle').textContent = place.name;
            
            let mediaHtml = '';
            if (place.media && place.media.length) {
                mediaHtml = `
                    <div class="gallery">
                        <${place.media[0].type} src="${place.media[0].data}" controls></${place.media[0].type}>
                        <div class="thumbnails">
                            ${place.media.map(m => `<${m.type} src="${m.data}" controls></${m.type}>`).join('')}
                        </div>
                    </div>
                `;
            } else {
                mediaHtml = `<img src="${MAP_IMG_SRC}" alt="${place.name}" style="width: 100%; border-radius: 8px;">`;
            }
            
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <span class="category-badge">${place.cat || '‚Äî'}</span>
                    <span>Created: ${new Date(place.created).toLocaleString()}</span>
                </div>
                <div style="margin-bottom: 15px;">${place.desc || 'No description'}</div>
                <div style="margin-bottom: 15px;">Coordinates: ${place.xPct}%, ${place.yPct}%</div>
                ${mediaHtml}
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn primary" onclick="centerOnPlace('${place.id}')">Center on Map</button>
                    <button class="btn" onclick="editPlace('${place.id}')">Edit</button>
                </div>
            `;
            
            document.getElementById('modal').classList.add('open');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('open');
        }
        
        function editPlace(placeId) {
            const place = places.find(p => p.id === placeId);
            if (!place) return;
            
            document.getElementById('pname').value = place.name;
            document.getElementById('pcat').value = place.cat || '';
            document.getElementById('px').value = place.xPct;
            document.getElementById('py').value = place.yPct;
            document.getElementById('pdesc').value = place.desc || '';
            
            // Show existing media
            const thumbsContainer = document.getElementById('thumbs');
            thumbsContainer.innerHTML = '';
            if (place.media && place.media.length) {
                place.media.forEach(media => {
                    const thumb = document.createElement(media.type);
                    if (media.type === 'video') thumb.controls = true;
                    thumb.src = media.data;
                    thumbsContainer.appendChild(thumb);
                });
            }
            
            closeModal();
            showPanel('add');
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(places, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'miniCityPlaces.json';
            a.click();
            
            URL.revokeObjectURL(url);
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
                places = [];
                savePlaces();
                alert('All data has been cleared.');
            }
        }
        
        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
